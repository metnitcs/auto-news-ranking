name: Auto News Cron
on:
  schedule:
    # Trending: 06, 12, 15, 18, 20 TH (23, 05, 08, 11, 13 UTC)
    - cron: '0 23,5,8,11,13 * * *'
    # Top 5: 20:30 TH (13:30 UTC)
    - cron: '30 13 * * *'
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job Type'
        required: true
        default: 'trending'
        type: choice
        options:
          - trending
          - top5 

jobs:
  auto-news-job:
    runs-on: ubuntu-latest
    steps:
      - name: Determine Job Type
        id: job-type
        run: |
          # Manual trigger: use input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.job_type }}" >> $GITHUB_OUTPUT
            echo "Manual trigger: ${{ github.event.inputs.job_type }}"
          else
            # Scheduled trigger: check time
            hour=$(date -u +%H)
            minute=$(date -u +%M)
            echo "Current time (UTC): $hour:$minute"
            
            if [ "$hour" -eq 13 ] && [ "$minute" -ge 25 ] && [ "$minute" -le 35 ]; then
              echo "type=top5" >> $GITHUB_OUTPUT
              echo "Detected Top 5 Schedule (13:30 UTC)"
            else
              echo "type=trending" >> $GITHUB_OUTPUT
              echo "Detected Trending Schedule"
            fi
          fi

      - name: Trigger Trending/Daily Process
        if: steps.job-type.outputs.type == 'trending'
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "Executing Trending Loop..."
          response=$(curl -s -w "\n%{http_code}" -X GET "${APP_URL}/api/cron/daily" -H "Authorization: Bearer ${CRON_SECRET}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          echo "Response: $body"
          echo "HTTP Status: $http_code"
          if [ "$http_code" -ne 200 ]; then
            echo "Error: API returned status $http_code"
            exit 1
          fi

      - name: Trigger Top 5 Generation
        if: steps.job-type.outputs.type == 'top5'
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "Executing Daily Top 5 Generation..."
          response=$(curl -s -w "\n%{http_code}" -X GET "${APP_URL}/api/cron/generate-top5" -H "Authorization: Bearer ${CRON_SECRET}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          echo "Response: $body"
          echo "HTTP Status: $http_code"
          if [ "$http_code" -ne 200 ]; then
            echo "Error: API returned status $http_code"
            exit 1
          fi
